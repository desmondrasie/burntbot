{% from 'components/list_user.html' import user %}

{% extends 'layout.html' %}

{% block body %}
	<div class = 'flex-col list-wrapper'>
		<div class = 'rounded list-header'>
			<h2>List</h2>
			<p style = 'margin-bottom: 0.25rem;'>Add people to your daily send list!</p>
			<p>Enter a single @shaketag, or a comma separated list and hit add. To delete existing shaketags, just press the <i class="far fa-trash-alt"></i> button!</p>
			<p class = 'warn-text m-top-1'>Something not right here? Come back later! The bot has to fetch new transactions for this page to update.</p>
			<div class = 'divider'></div>
			<div class = 'list-header-input flex-row'>
				<div>
					<form id = 'submit' autocomplete = 'off' class = 'flex-col'>
						<input id = 'list-tag' placeholder = 'tag1,tag2,tag3, ...'>
						<button type = 'submit' class = 'contained'>ADD</button>
					</form>
				</div>
				<div class = 'flex-col'>
					<input autocomplete = 'off' id = 'list-note' placeholder = 'custom note (optional)' value = '{{ data["note"] }}'>
					<button id = 'list-note-save' type = 'submit' class = 'contained' onclick = save_list_note(this)>SAVE</button>
				</div>
			</div>
		</div>
		<div class = 'flex-row list-users-wrapper'>
			<div class = 'rounded'>
				<div class = 'list-send-wrapper'>
					<h2><i class="fas fa-list-ul"></i> Not Sent</h2>
					<button id = 'send' type = 'submit' class = 'contained'>SEND ALL</button>
				</div>
				<p>You haven't sent to these people yet</p>
				<div>
					{% for shaketag, children in data['to_send'].items() %}
						{{ user(shaketag, children, 1) }}
					{% endfor %}
				</div>
			</div>
			<div class = 'rounded'>
				<h2><i class="far fa-clock"></i> Waiting</h2>
				<p>Waiting for returns from these people</p>
				<div id = 'list-waiting'>
					{% for shaketag, children in data['waiting'].items() %}
						{{ user(shaketag, children) }}
					{% endfor %}
				</div>
			</div>
			<div class = 'rounded'>
				<h2><i class="fas fa-check"></i> Done</h2>
				<p>All done for today, come back next reset</p>
				<div>
					{% for shaketag, children in data['done'].items() %}
						{{ user(shaketag, children) }}
					{% endfor %}
				</div>
			</div>
		</div>
	</div>

	<script>
		function add_shaketags(event) {
			event.preventDefault();

			let input = document.getElementById('list-tag');
			let data = [];

			// dont care about valid tags, validate on server
			for (let shaketag of input.value.split(',')) {
				data.push(shaketag);
			}

			console.log(event);

			fetch('/list/', {
				method: 'PATCH',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({shaketags: data})
			})
			.then((data) => {
				if (data.ok) {
					window.location.reload();
				}
			});
		}

		function send_list(click_event) {
			let button = click_event.target;
			
			set_loading(button);
			button.disabled = true;

			let stream = new EventSource('/list/send/');

			let waiting = document.getElementById('list-waiting');
			stream.onmessage = (event) => {
				console.log('message', event);

				if (event.data === 'done') {
					console.log('done');
					stream.close();

					button.innerHTML = 'SEND ALL'
					button.disabled = false;
				} else {
					let list_user = document.querySelector(`div.rounded.list-user[data-shaketag="${event.data}"]`);

					// remove the override button in case the user gets any funny ideas
					let buttons = list_user.querySelectorAll('button');
					if (buttons.length > 1) {
						buttons[0].remove();
					}

					waiting.append(list_user);
				}
			}

			stream.onerror = (event) => {
				console.log('error, stopped');
				console.log('error', event);
				stream.close();
			}
		}

		function save_list_note(button) {
			button.disabled = true;
			set_loading(button);

			let note = document.getElementById('list-note').value;

			fetch('/list/note/', {
				method: 'PATCH',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({note: note})
			})
			.then((data) => {
				if (data.ok) {
					button.disabled = false;
					set_checkmark(button);
				}
			});
		}

		document.getElementById('submit').addEventListener('submit', add_shaketags);
		document.getElementById('send').addEventListener('click', send_list);
	</script>
{% endblock %}